---
- hosts: controllers
  become: yes
  gather_facts: yes

  tasks:
  - name: Add key for kubernetes
    apt_key:
      url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
      state: present

  - name: Add repo for kubernetes
    apt_repository:
      repo: deb http://apt.kubernetes.io/ kubernetes-xenial main
      state: present

  - name: Install kubernetes packages
    apt:
      name: [ 'kubeadm',
              'kubelet',
              'kubectl'
      ]
      update_cache: yes
      state: latest

  - name: Start kubelet service
    service:
      name: kubelet
      state: started
      enabled: yes

  - name: Initialize pod-network
    shell: kubeadm init --pod-network-cidr=10.244.0.0/16
    register: result_outcome
    failed_when: 
      - result_outcome.rc != 0 
      - '"Some fatal errors occurred:" in result_outcome.stderr'
    ignore_errors: true
    no_log: true
    tags: pod-net

  - name: Initialization of pod-network is failed
    debug:
      msg: |
        May be pod-network initialization done. Run 
        kubeadm init --pod-network-cidr=10.244.0.0/16
    when: 
      - result_outcome.rc != 0 
      - '"Some fatal errors occurred:" in result_outcome.stderr'
    tags: pod-net
